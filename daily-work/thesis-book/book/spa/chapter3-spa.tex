%avoid page number on blank pages when cleared
\thispagestyle{empty}
\cleardoublepage  
\chapter{METODOLOG\'IA DE LA SOLUCI\'ON}
\label{chap:methodology}

En este cap\'itulo se presenta la metodolog\'ia general de la soluci\'on,
que consiste en las diferentes etapas de procesamiento de im\'agenes que deben ser
llevadas a cabo para detectar eficazmente la forma de gusanos C. elegans presentes
en im\'agenes digitales. Primero, se presenta una descripci\'on general de la 
metodolog\'ia, donde se justifica el dise\~no de la soluci\'on y se presentan los 
diferentes procesos involucrados.
Luego, se explica cada proceso de manera individual, aclarando su respectiva utilidad y necesidad.
Por cada proceso se presenta, adem\'as, las caracter\'isticas de su implementaci\'on en este trabajo,
lo que da origen al algoritmo que aqu\'i se provee.

\section{Dise\~no de la Metodolog\'ia: Razonamiento Previo}
\label{sec:reasoning}

A continuaci\'on se presenta el razonamiento previo que condujo al
dise\~no de la metodolog\'ia presentada en la Sec. \ref{met:description}
(la metodolog\'ia general es descrita gr\'aficamente en la Figura \ref{fig:methsol}).\\
 
Como se explica en \cite{binaryshape,deformable,matching2,matchingbook},
uno de los enfoques m\'as comunes para el ajuste de formas consiste en adoptar
un descriptor de forma, construir una silueta a partir del descriptor,
y posicionar dicha silueta lo suficientemente cerca del objeto a ajustar en
la imagen. Seguidamente, variar los valores de los par\'ametros 
del descriptor, deformando la silueta inicial, hasta que se logre una 
coincidencia aceptable entre la silueta generada y el objeto en la imagen.\\
 
La utilizaci\'on de un descriptor de forma suele ser apropiado
cuando los objetos a ser ajustados pueden ser categorizados
en un clase espec\'ifica, y pueden ser descritos
en t\'erminos geom\'etricos.
El problema de estudio tiene como objetivo la detecci\'on y ajuste
de gusanos, particularmente aquellos que pertenece a la especie
C. elegans. Dado la propiedad vermiforme de estos individuos, los
objetos a detectar pueden ser agrupados en una \emph{clase gusano},
a la que pertenecer\'ian aquellos objetos que cumplen con las propiedades
geom\'etricas de tener una forma alargada, delgada y cil\'indrica, en
t\'erminos generales.
Siguiendo esta idea, se puede definir un descriptor que 
permita generar siluetas de gusanos. Este descriptor podr\'ia
estar representado por dos puntos extremos (los extremos del gusano)
y un conjunto de valores de grosor a lo largo del eje medio que
conecta dichos extremos. Luego, el problema quedar\'ia
reducido a encontrar cada par de puntos extremos de gusanos en la
imagen, ubicar una silueta aproximada (construida a trav\'es
del descriptor de forma) cerca del gusano a ajustar, y deformar 
la silueta hasta encontrar una coincidencia factible.\\

Para este estudio, las im\'agenes de entrada consisten, b\'as\'icamente, en
tomas de microscopio de un conjunto de gusanos agrupados en medio 
l\'iquido. Las im\'agenes pueden contener algo de ruido tal como: 
sombras, burbujas de aguas o peque\~nos restos que no pertenecen a
los gusanos, y que por tanto deben ser separados del resto de la imagen. La
posici\'on de cada gusano individual en la imagen es variable y puede
ser distinguida en dos grandes grupos: agrupaciones de gusanos y gusanos aislados.
Una agrupaci\'on de gusanos corresponde a un conjunto de gusanos que aparecen en la
imagen solap\'andose entre s\'i. De esta manera, cada gusano que pertenece
a la agrupaci\'on est\'a conectado con el resto de manera directa o indirecta,
 a trav\'es de solapamiento. O lo que es lo mismo, desde cada gusano en la agrupaci\'on,
se puede trazar un camino hacia otro gusano sin pasar por p\'ixeles de fondo.  
Por otro lado, los gusanos aislados, son aquellos que estan rodeados por
p\'ixeles de fondo y que no se solapan con ning\'un otro gusano.\\

Los diferentes gusanos aislados y agrupaciones de gusanos podr\'ian ser
separados f\'acilmente del resto de la imagen, permitiendo as\'i, 
procesar cada uno individualmente. El contorno de los gusanos aislados
puede ser trazado f\'acilmente siguiendo los p\'ixeles del objeto que
estan m\'as cercanos a los p\'ixeles de fondo. Habiendo ajustado las formas
de gusanos aislados, estas podr\'ian utilizarse para generar un perfil
de gusano, que definir\'ia los valores generales para un descriptor de forma
gen\'erico. Esto permitir\'ia describir la silueta que mejor se ajusta a todos
los gusanos de la imagen, en general.
Los gusanos que pertenecen a agrupaciones de gusanos, se podr\'ian detectar
individualmente, a trav\'es de un proceso de ajuste de siluetas como
el mencionado al comienzo de esta secci\'on.

\section{Descripci\'on de la Metodolog\'ia e Implementaci\'on}
\label{met:description}

\subsection{Descripci\'on General}

La metodolog\'ia presenta un dise\~no general por etapas, 
independiente de la implementaci\'on particular de cada una de estas. De esta
manera, se presenta una visi\'on general de la soluci\'on, y as\'i diferentes
algoritmos pueden ser desarrollados que se ajusten a esta metodolog\'ia.
Se provee, adem\'as, un enfoque espec\'ifico de implementaci\'on por etapa, que da
origen al algoritmo que fue implementado y probado en este trabajo.\\

Siguiendo el razonamiento de la secci\'on anterior, se dise\~n\'o una metodolog\'ia tomando en cuenta
los aspectos principales del proceso de detecci\'on y ajuste de formas estudiado, como lo son:
identificaci\'on general de gusanos en la imagen, segmentaci\'on de gusanos, 
descriptor de forma de gusanos y optimizaci\'on del ajuste de formas.

A continuaci\'on, se describe la metodolog\'ia de la soluci\'on de forma general,  y
seguidamente se explica cada etapa de forma detallada.
En la Figura \ref{fig:methsol} se presenta una descripci\'on gr\'afica de la metodolog\'ia.\\

\begin{figure}[h t b p ! H]
 \centering
   \includegraphics[scale=0.9,angle=270]{diagrams/design.pdf}
 \caption{Descripci\'on gr\'afica de la metodolog\'ia para detectar gusanos C. elegans
   en im\'agenes digitales}
\label{fig:methsol}
\end{figure}

Dada la imagen de entrada, el primer paso consiste en separar los p\'ixeles que
pertenecen a los objetos de estudio (gusanos) del resto de la imagen. Para esto,
se utiliza alg\'un m\'etodo del valor umbral (MVU) que permita calcular una imagen
binaria que separe p\'ixeles de gusanos de los p\'ixeles del fondo. Por lo general,
este proceso no es completamente eficaz, y se obtiene algo de ruido en la imagen, el
cual debe ser eliminado en procesamientos posteriores. Esta primera etapa corresponde
a una segmentaci\'on inicial de la imagen de entrada.
Seguidamente, a partir de la imagen binaria, se puede calcular una transformada de
distancia o mapa de distancias, en la cual se almacena la distancia de cada pixel
al pixel de fondo m\'as cercano. La transformada de distancia hace posible identificar
f\'acilmente los p\'ixeles de contorno en la imagen binaria, lo que la convierte en
una herramienta fundamental para la generaci\'on autom\'atica de perfiles de gusanos,
el trazado de contornos en gusanos aislados y para la optimizaci\'on del proceso
de \emph{esqueletizaci\'on}, entre otros. \\

Habiendo determinado los p\'ixeles que pertenecen a gusanos en la imagen, se pueden separar
los grupos de p\'ixeles que estan conectados y rodeados por p\'ixeles de contorno. Esta
segmentaci\'on provee diversos grupos de p\'ixeles objetos. Cada uno de estos grupos
podr\'ia ser tanto un gusano aislado como una agrupaci\'on de gusanos, de acuerdo a la diferenciaci\'on
expuesta en la Sec. \ref{sec:reasoning}.
Una manera de diferenciar los diferentes grupos es contando el n\'umero de extremos y de intersecciones. 
Un grupo que contiene exactamente dos puntos extremos y que
no presenta intersecciones corresponder\'a a un gusano aislado. Por otro lado, si el grupo presenta
m\'as de dos puntos extremos, o al menos una intersecci\'on, esto indicar\'a la presencia de 
solapamiento de gusanos, por tanto corresponder\'a a una agrupaci\'on de gusanos.\\

El enfoque de ajuste de formas se centra en ubicar inicialmente una silueta de gusano gen\'erica 
cerca de un posible gusano en la imagen. De esta manera, es necesario poder determinar, con cierto grado
de precisi\'on y factibilidad, \'areas que pertenezcan a gusanos individuales en la imagen. Para este prop\'osito,
el esqueleto topol\'ogico de la imagen proveer\'ia un camino continuo a trav\'es del eje medio
de los objetos inicialmente segmentados, conectando puntos extremos de gusanos. Al mismo tiempo, permitir\'ia
detectar gran cantidad de puntos extremos.\\

Seguidamente, los diferentes grupos segmentados son procesados para detectar 
y ajustar la forma de los gusanos individuales que los conforman.
Los dos tipos de grupos definidos (agrupaciones de gusanos y gusanos aislados),
son procesados de formas diferentes. 

\subsubsection*{Gusanos Aislados}
El contorno de la silueta de los gusanos aislados puede ser trazada f\'acilmente de 
la siguiente forma: se selecciona un pixel de contorno (indicado en el mapa de distancias)
y se construye un camino siguiendo el pixel de contorno vecino en cada paso, hasta que
se cierre el contorno. Luego, la silueta puede ser \emph{rasterizada} construyendo 
una maya triangulada y, seguidamente, \emph{rasterizando} cada triangulo por separado. Esto
proveer\'ia el conjunto de los p\'ixeles que pertenecen a la forma del gusano, por lo que
la forma quedar\'ia ajustada.\\
El ajuste cas\'i perfecto que se puede obtener de los gusanos aislados, hace posible
calcular un perfil de gusano que represente a los individuos de la muestra, de forma
general. De esta manera, se puede construir un descriptor de forma preciso (esto 
es explicado a fondo en la secci\'on \ref{sec:metshapedescriptor}).

\subsubsection*{Agrupaciones de Gusanos}
Para detectar los gusanos individuales presentes en una agrupaci\'on de gusanos, 
se calculan las formas de gusanos factibles entre par de puntos extremos y luego 
se determina cuales de aquellas tienen m\'as probabilidades de pertenecer a gusanos 
en la imagen. \\

El proceso en general es como sigue: dado un par de puntos extremos, se selecciona
alg\'un camino entre ellos. Luego, se escogen un conjunto de puntos control y
a partir de estos puntos y del descriptor de forma, 
se genera una silueta de gusano alrededor del camino. Dicho camino constituye el 
eje medio de la silueta generada. Despu\'es de esto, se lleva a cabo un proceso de 
ajuste de formas, que consiste en minimizar la distancia que existe entre la silueta
generada y el gusano que presumiblemente se encuentra dispuesto en un espacio 
cercano al camino escogido, hasta que el mejor ajuste es encontrado. Una forma ajustada,
despu\'es del proceso de minimizaci\'on, se denomina conformaci\'on. Una conformaci\'on 
corresponde a la mejor silueta de gusano que se puede construir a partir de un camino
entre dos extremos determinados, y que presumiblemente representa a un gusano real
de la imagen. \\

Este proceso es repetido para cada camino de gusanos factible que puede ser encontrado
a partir de cada punto extremo. De esta manera, se obtienen todas las conformaciones
posibles en el imagen. Luego, un algoritmo de as\'ignaci\'on permitir\'a seleccionar
el mejor conjunto de conformaciones, que maximice el n\'umero de puntos extremos cubiertos
y minimice el valor acumulado de energ\'ia. Las conformaciones escogidas incorrectamente
a trav\'es de la as\'ignaci\'on autom\'atica, podr\'an ser corregidas siguiendo
un sencillo proceso manual.\\

Un algoritmo de predicci\'on de caminos puede ser utilizado para encontrar
los caminos de gusano m\'as probables, que parten de un punto extremo dado.
Las conformaciones resultantes de los caminos predichos por el algoritmo podr\'ian
ser beneficiados sobre otras conformaciones, para aumentar la probabilidad de que
sean escogidos.\\

En las secciones siguientes se cubren detalladamente los diferentes procesos
involucrados en la metodolog\'ia presentada, y se presenta el enfoque particular
de implementaci\'on seguido en este trabajo, para cada uno de ellos.
  

\subsection{Segmentaci\'on Inicial (M\'etodo del Valor Umbral)}
\label{sec:metthres}

Dado que el prop\'osito principal de este estudio es detectar y ajustar la forma de 
gusanos C. elegans en im\'agenes digitales, un paso inicial fundamental es el de separar
las formas de gusanos lo m\'as posible del resto de la imagen, para as\'i poder llevar a
cabo un an\'alisis m\'as preciso.\\

Sean los gusanos en la imagen los objetos a separar y considerando el resto de la imagen
como fondo o segundo plano, los p\'ixeles de la imagen puede ser separados en dos grupos: 
p\'ixeles de objeto y p\'ixeles de fondo. Dada esta caracterizaci\'on, un m\'etodo del valor
umbral permitir\'ia separar los objetos en la imagen digital y descartar la informaci\'on
innecesaria, representando esto a trav\'es de una imagen binaria. La imagen binaria proveer\'ia
entonces una segmentaci\'on inicial de la imagen original, siendo adem\'as clave para el
c\'alculo del mapa de distancias de la imagen, como se explica en la Sec. \ref{sec:metdt}.
En general, para esta etapa de la metodolog\'ia, cualquier MVU que permita obtener una imagen
binaria que identifique satisfactoriamente los p\'ixeles que pertenecen a los gusanos de la
imagen, ser\'a suficiente para continuar el proceso normalmente, sin importar la existencia
de ruido leve en la imagen.


\subsubsection*{Implementaci\'on}
\label{sec:thresimp}

Existen cuatro MVU para im\'agenes en 2D implementados en \emph{Endrov},
estos son: \emph{Fukunaga}, \emph{m\'axima entrop\'ia}, \emph{Otsu} y \emph{percentil},
que cubren las categor\'ias de MVU basados en histogramas y MVU basados en entrop\'ia 
(ver Sec. \ref{sec:thresholding}). Dada la condici\'on de transparencia de los gusanos
C. elegans, es dif\'icil determinar te\'oricamente cual vendr\'ia a ser el m\'etodo m\'as apropiado 
para obtener una imagen binaria precisa. \\
Por esta raz\'on, se realizaron una serie de experimentos
para seleccionar el m\'etodo m\'as apropiado. Estos experimentos consistieron en el ajuste manual
de los diferentes par\'ametros de cada uno de los m\'etodos mencionados, que fueron aplicados
sobre un conjunto de im\'agenes de prueba. La precisi\'on de segmentaci\'on de las im\'agenes binarias
obtenidas en cada caso, se midi\'o a trav\'es de una comparaci\'on visual con la imagen original.\\
El m\'etodo que mejor se comport\'o en estos experimentos resulto ser el 
\emph{m\'etodo del valor umbral por percentil}, 
al ser el m\'as f\'acil de ajustar manualmente y aquel que retorn\'o el equivalente binario m\'as preciso, 
en cada caso. Un an\'alisis m\'as detallado sobre la escogencia del m\'etodo de valor umbral para esta metodolog\'ia
se presenta en la secci\'on de experimentos del cap\'itulo cuatro (ver Sec. \ref{chap:experiments}).\\

En la figura \ref{fig:wormthres} se presenta una imagen binaria, obtenida al
aplicar el \emph{m\'etodo del valor umbral por percentil}.

\begin{figure}[h t b p ! H]
  \centering
  \subfloat[Imagen original]{\includegraphics[width=0.45\textwidth]{original.png}}
\qquad
  \subfloat[M\'etodo del valor umbral por percentil. Valor=0.074]{\includegraphics[width=0.45\textwidth]{thres/worms}}
\caption{Gusanos en medio l\'iquido. Imagen original e imagen binaria obtenida a trav\'es
del m\'etodo del valor umbral por percentil, con un percentil de 0.074}
  \label{fig:wormthres}
\end{figure}

\subsection{Transformada de Distancia}
\label{sec:metdt}

La transformada de distancia de la imagen binaria es utilizada a fondo en el
seguimiento de contorno y en diferentes tipos de procedimientos de segmentaci\'on.
Espec\'ificamente, el mapa de distancias permite detectar y delinear el contorno
exacto de gusanos aislados (Sec. \ref{sec:metiso}), es \'util en la generaci\'on
autom\'atica de perfiles de gusanos (Sec. \ref{sec:metwormprof}), y es esencial en 
la predicci\'on heur\'istica de caminos de gusanos m\'as probables (Sec. \ref{sec:pathguessing}). 
As\'i mismo, permite mejorar el rendimiento de algoritmo iterativo de reducci\'on de capas
dise\~nado por \emph{Zhang y Suen}, \cite{thinning}, como se describe en 
la Sec. \ref{sec:metsk}

\subsubsection*{Implementaci\'on}
\label{sec:dtimp}

Tal como se describe en \cite[p.196]{fastdt}, los algoritmos para calcular transformadas de distancia pueden ser
categorizados en dos grandes clases: m\'etodos iterativos y m\'etodos secuenciales o recursivos. 
Los m\'etodos iterativos son particularmente eficientes en computadoras de arreglos celulares
dado que se pueden procesar todos los p\'ixeles en paralelo en cada iteraci\'on. Por otro lado, los m\'etodos secuenciales
se ajustan mejor a computadoras convencionales, al evitar iteraciones por ser independientes del tama\~no de los objetos.
Tomando en cuenta los tipos de computadoras a la que tienen acceso la mayor\'ia de las personas que trabajan
en el procesamiento de im\'agenes digitales, los algoritmos secuenciales ofrecen un rendimiento mucho m\'as
eficiente que los iterativos. Por esta raz\'on, se escogi\'o un enfoque secuencial para calcular la 
transformada de distancia de las im\'agenes de entrada. Particularmente se utiliz\'o el algoritmo de
transformaci\'on de dos recorridos con vecindarios de 3x3, presentado en \cite{fastdt}, que es
tanto eficiente como sencillo de implementar.\\

En el trabajo antes mencionado, se describe un algoritmo para calcular el mapa 
de distancias de una imagen en formato de mapa de bits, que consiste en dos recorridos y
una operaci\'on por pixel. La complejidad del algoritmo es $\mathcal{O}(N)$, donde $N$ 
es el tama\~no del arreglo que contiene la imagen.
En dicho trabajo se presenta, inicialmente, un pseudo-c\'odigo para las m\'etricas 
de distancia de \emph{Manhattan} y \emph{tablero de ajedrez}, \cite[p.197]{fastdt}.
Luego, la definici\'on es extendida para mejorar la eficiencia de los c\'alculos 
requeridos para generar un mapa de distancias a trav\'es de la m\'etrica de distancias
\emph{Euclideanas}, \cite[p.198]{fastdt}.
Este algoritmo de dos recorridos, fue implementado utilizando las tres m\'etricas de
distancia mencionadas anteriormente. Esto permite realizar una an\'alisis m\'as amplio
del comportamiento y precisi\'on del proceso de ajuste de formas, al cambiar de
una m\'etrica a la otra. Esto es debido a que los mapas de distancia generados por 
diferentes m\'etricas, representan a los objetos de maneras diferentes, y tienden
a ser sensible a cambios posicionales u otras propiedades. En \cite[p.332]{eucskeleton}
se asegura que las m\'etricas de \emph{tablero de ajedrez} y \emph{Manhattan} son
sensibles a las rotaciones de los objetos, mientras que la m\'etrica \emph{Euclidiana}
permanece invariable ante estas rotaciones; sin embargo, es mucho m\'as costosa de calcular.\\

Dada la forma alargada y estrecha de los gusanos C. elegans, y los diferentes niveles
de precisi\'on que proveen dichas m\'etricas de distancia, es dif\'icil decidir
cual se ajusta mejor al problema de estudio, por lo que debe ser determinado
experimentalmente. La Figura \ref{fig:distance} muestra una imagen binaria y tres
mapas de distancia obtenidos a partir de una imagen que contiene, \'unicamente, un
gusano aislado.

\begin{figure}[h t b p ! H]
  \centering
  \subfloat[Imagen Binaria]{\label{fig:manh}\includegraphics[width=0.35\textwidth]{dt/binary}}
\qquad
  \subfloat[Distancia de Manhattan]{\label{fig:manh}\includegraphics[width=0.35\textwidth]{dt/manhattandt}}
\qquad                
  \subfloat[Distancia de tablero de ajedrez]{\label{fig:chess}\includegraphics[width=0.35\textwidth]{dt/chessboarddt}}
\qquad
  \subfloat[Distancia Euclidiana]{\label{fig:mouse}\includegraphics[width=0.35\textwidth]{dt/euclideandt}}
  \caption{ Imagen binaria y tres mapas de distancia utilizando diferentes m\'etricas,
    a partir de la imagen de un gusano}
  \label{fig:distance}
\end{figure}

\subsection{\emph{Skeletonization}}
\label{sec:metsk}

La \emph{skeletonization} de la imagen corresponde al proceso de obtener un 
camino de p\'ixeles conectado y delgado, que tienda
al eje central o eje medio de los gusanos en la imagen. A este camino se le
denomina esqueleto. Este es un proceso
clave en el enfoque de detecci\'on presentado en este trabajo, tal como
se enuncia inicialmente en la Sec \ref{met:description}. El esqueleto de la
imagen hace posible identificar la cantidad de gusanos presentes, permite
diferenciar y separar las agrupaciones de gusanos de los gusanos aislados, 
y m\'as importante, provee caminos entre extremos de gusanos (que tienden
al eje medio). Estos caminos son fundamentales en el proceso de ajuste
de formas (ver Sec \ref{sec:metsegmentation}), pues proveen informaci\'on
acerca de la localizaci\'on de los gusanos en la imagen, al constituir trayectorias
a lo largo de las cuales podr\'ian estar dispuestos gusanos en la imagen.

\subsubsection*{Implementaci\'on}
\label{sec:skeletonimp}


Para los efectos de este trabajo, el algoritmo de \emph{skeletonization} a ser
seleccionado debe garantizar la conectividad de los puntos del esqueleto, \emph{i.e.}
cada punto del esqueleto debe estar conectado con al menos otro punto del mismo
esqueleto. As\'i mismo, el esqueleto debe ser tan delgado como sea posible 
(hasta un 1 pixel de grosor) para simplificar el procesamiento y an\'alisis de caminos.\\

Existen diferentes m\'etodos que consisten en encontrar los puntos cresta en el
mapa de distancias y conectarlos, como se explica en \cite{maxima,euclideancentre,ridgedt}. 
El enfoque presentado en \cite{maxima} fue seguido inicialmente para calcular un esqueleto
de imagen delgado en un tiempo de ejecuci\'on muy corto. Pese a que el estudio garantiza
que el algoritmo permite calcular, satisfactoriamente, esqueletos conectados de un pixel
de grosor, este result\'o ser eficaz \'unicamente para los gusanos aislados. Los esqueletos
obtenidos para agrupaciones de gusanos resultaron generalmente desconectados, 
de m\'as de un pixel de grosor y poco precisos. Estos llevo a la utilizaci\'on
de un enfoque diferente.\\

En \cite{thinning} se presenta un algoritmo iterativo para calcular el esqueleto de
una imagen binaria. El algoritmo consiste, b\'as\'icamente, en la remoci\'on por capas
de aquellos p\'ixeles que, de acuerdo a determinados criterios, no pertenecen al esqueleto
del objeto. El dise\~no del algoritmo est\'a dirigido a computadoras con procesadores 
paralelos, de manera que se puedan ejecutar varias operaciones de pixel al mismo tiempo,
y mejorar as\'i el rendimiento. Para evitar el requerimiento de utilizar computadores
con procesadores paralelos, sin desmejorar el rendimiento significativamente,
el algoritmo fue ligeramente modificado. Dicha modificaci\'on consiste en utilizar
el mapa de distancias para descartar chequeo de p\'ixeles que pertenecen a capas
m\'as profundas que la capa que est\'a siendo reducida en un momento determinado.
Esto toma ventaja de la naturaleza de los mapas de distancia, quienes, por definici\'on,
establecen capas de distancia entre los p\'ixeles del objeto y el fondo de la imagen.\\
De esta manera, las capas se definen por el valor que tiene cada pixel en el mapa 
de distancias. La primera capa corresponde a un valor de distancia de uno ($1$), la segunda
un valor de dos ($2$) y as\'i sucesivamente. El algoritmo es presentado en \ref{thinninalg}.

\begin{algorithm}                     
\caption{\emph{skeletonization} por reducci\'on por capas}         
\label{thinninalg}                    
\begin{algorithmic}                   
\STATE $pixelesObjeto \leftarrow obtenerPixelesObjetoBinario()$
\STATE $imagenTD \leftarrow calcularTransformadaDistancia()$
\STATE $indiceContorno \leftarrow 1$
\STATE $reducir = True$

\WHILE{$reducir$}

\STATE \COMMENT{eliminar p\'ixeles del borde sur-este y pixel de
esquina nor-oeste}
\FOR{$pixel$ in $pixelesObjeto$}
\IF{$ImagenDT(pixel) > indiceContorno$}
\STATE \COMMENT{saltar iteraci\'on}
\ELSE
\STATE $eliminarPixel \leftarrow condicionSurEste(pixel)$
\IF{$eliminarPixel$}
\STATE $pixelesObjeto.eliminar(pixel)$
\STATE $reducir \leftarrow True$
\ENDIF

\ENDIF
\ENDFOR


\STATE \COMMENT{eliminar p\'ixeles del borde nor-oeste y pixel
esquina sur-este}
\FOR{$pixel$ in $pixelesObjeto$}
\IF{$imagenTD(pixel) > indiceContorno$}
\STATE \COMMENT{saltar iteracion}
\ELSE
\STATE $eliminarPixel \leftarrow condicionNorEste(pixel)$
\IF{$eliminarPixel$}
\STATE $pixelesObjeto.eliminar(pixel)$
\STATE $reducir \leftarrow True$
\ENDIF
\ENDIF
\ENDFOR
\ENDWHILE
\STATE 
\RETURN{$pixelesObjeto$}

\end{algorithmic}
\end{algorithm}

El algoritmo se ocupa bien de los gusanos que se solapan, al construir un camino que 
se aproxima bien al eje central de las figura, y resulta en un esqueleto totalmente
conectado y delgado (mayoritariamente 1-pixel de grosor).
En la Figura \ref{fig:skeleton} se presenta el esqueleto de un conjunto de gusanos.

\begin{figure}[h t b p ! H]
 \centering
   \includegraphics[scale=0.75]{skeleton/skeleton.png}
 \caption{Esqueleto obtenido a trav\'es de reducci\'on por capas iterativa
   de un conjunto de gusanos}
\label{fig:skeleton}
\end{figure} 

\subsection{Segmentaci\'on de Gusanos}
\label{sec:metsegmentation}

Dado que el objetivo es ajustar las formas de gusanos individuales, es 
necesario localizarlos en la imagen y separarlos lo m\'as posible, 
\emph{i.e. }segmentar la imagen. La segmentaci\'on de los objetos 
de estudio permite mejorar la eficiencia y precisi\'on del proceso
de ajuste de formas, al reducir el \'area a analizar, disminuyendo as\'i
la cantidad de combinaciones diferentes que deben ser tomadas en cuenta.
Una vez que se han identificado los puntos extremos, se pueden calcular
los diferentes caminos que existen entre ellos a partir del esqueleto.
A trav\'es del conjunto de puntos extremos y de la cantidad de caminos e 
intersecciones, se puede determinar el tipo de grupo de gusanos al que
pertenece cada grupo de objetos segmentados, ya sean gusanos aislados
o agrupaciones de gusanos. De esta manera, el proceso de ajuste de formas
se puede llevar a cabo en cada grupo por separado.\\

Otro proceso de segmentaci\'on que debe ser llevado a cabo es la identificaci\'on
de caminos de gusanos individuales, tanto para gusanos aislados como para agrupaciones
de gusanos. Estos son caminos que no tiene bifurcaciones y que comienzan y terminan
en puntos extremos.\\
El esqueleto de un gusano aislado determinado corresponde a un camino de este tipo, y es
utilizado para dos procesos diferentes: encontrar el contorno del gusano aislado 
(ver Sec. \ref{sec:metiso}) y generar un perfil de gusanos (ver Sec. \ref{sec:metwormprof}).
El perfil de gusanos permite definir una representaci\'on general de los gusanos en 
la imagen. De esta manera, a trav\'es del perfil y un camino entre dos extremos, se puede
construir una silueta de gusano, que tiene como eje central al camino escogido. \\

Con respecto a las agrupaciones de gusanos, se deben encontrar caminos de gusanos factibles entre
pares de puntos extremos. Si un camino existe entre un par de puntos extremos, ser\'a posible
generar una conformaci\'on de gusano valida a trav\'es del proceso de optimizaci\'on. 
Estos caminos pueden ser escogidos tanto calculando todas las combinaciones de caminos posibles
entre par de puntos extremos, como a trav\'es de un algoritmo de predicci\'on de caminos probables,
como el que se describe m\'as adelante en esta secci\'on.

\subsubsection*{Implementaci\'on}

A continuaci\'on se presentan detalles de la implementaci\'on realizada
de cada uno de los diferentes procesos previamente descritos en esta secci\'on, 
relativos a la segmentaci\'on de gusanos.

\subsubsection*{Puntos Extremos de Gusanos}
\label{sec:wend}

A partir del esqueleto calculado se pueden detectar puntos extremos 
de gusanos. Aquellos p\'ixeles del esqueleto que estan conectados
(son vecinos) de dos o m\'as p\'ixeles se denominan p\'ixeles de cuerpo.
Estos p\'ixeles de cuerpo pertenecen al esqueleto pero no son extremos.
Por otro lado, los puntos extremos del esqueleto son aquellos que estan conectados con
un solo pixel y pueden corresponder al extremo de un gusano, aunque no
necesariamente.\\

Dado que el algoritmo de \emph{skeletonization} basado en reducci\'on por capas
no permite asegurar que los extremos identificados pertenezcan a extremos
de gusanos en la imagen, se debe llevar a cabo un proceso de expansi\'on
del esqueleto, para alcanzar los puntos extremos reales.
El algoritmo se fundamenta en estirar los extremos del esqueleto, siguiendo
una direcci\'on coherente, hasta alcanzar puntos de contorno que vendr\'ian a 
representar los extremos de los gusanos. El algoritmo de expansi\'on utiliza
la definici\'on de \emph{vecino direccional}, que se presenta en \cite[p.334]{maxima}.
Un pixel $D$ es \emph{vecino direccional} de otro pixel $P$, si pertenece a
la vecindad de $P$ (\emph{8-vecindad}) y est\'a localizado dentro de un rango de 
$\pm$ $45^{\circ}$  de cambio de pendiente, con respecto a la orientaci\'on actual
del camino recorrido hasta $P$. En la Figura \ref{fig:directional} se presentan 
tres ejemplos de vecindades direccionales.\\
El algoritmo consiste en seguir el mejor camino direccional, partiendo de cada
punto extremo y expandiendo el esqueleto, hasta que un punto de contorno es
encontrado.
 
\begin{figure}[h t b p ! H]
 \centering
   \includegraphics[scale=1]{skeleton/directional.pdf}
 \caption{Tres vecindades direccionales}
 \label{fig:directional}
\end{figure}

El algoritmo de expansi\'on de esqueleto puede ser resumido en 
los siguientes pasos:

\begin{itemize}
\item Seleccionar un punto extremo.
\item Encontrar el pixel de esqueleto anterior y calcular la
  vecindad direccional.
\item Seleccionar el vecino direccional con el menor valor en el
  mapa de distancia y marcarlo como pixel de esqueleto.
\item Si el vecino seleccionado no es un punto de contorno, repetir
  el proceso.
\end{itemize}

Seguidamente se lleva a cabo un proceso de remoci\'on de p\'ixeles de objeto 
incorrectos, que consiste en eliminar aquellos esqueletos cuyo tama\~no (en 
cantidad de p\'ixeles) sea menor que un umbral determinado. Esto permite remover
regiones ligeramente ruidosas, as\'i como punto extremos incorrectos.
Una vez que el esqueleto ha sido expandido satisfactoriamente, los puntos
extremos del esqueleto son marcados como puntos extremos de gusanos.\\

Es importante considerar que, en algunos casos, hay puntos extremos de gusanos
que no puede ser detectados a trav\'es del proceso previamente descrito. 
Particularmente en im\'agenes con gran cantidad de gusanos, donde existe
una alta posibilidad de que los solapamientos entre gusanos oculten
puntos extremos. Para solucionar esto, se puede llevar a cabo un proceso
manual de adici\'on de puntos extremos faltantes, como se explica en 
la Sec. \ref{sec:manualproc}.


\subsubsection*{Segmentaci\'on en Grupos}


Habiendo detectados los puntos extremos de los diferentes grupos de esqueletos
en la imagen, se puede identificar a qu\'e tipo de grupo de gusano corresponde cada uno:
ya sea agrupaciones de gusanos o gusanos aislados. Esto se hace identificando
los extremos de gusanos que estan unidos a trav\'es de un camino del esqueleto.
Como se explic\'o previamente, los gusanos que se superponen son considerados 
parte de un objeto en com\'un en la imagen binaria, por lo que los puntos
extremos que pertenecen a los esqueletos de agrupaciones de gusanos se encuentran
conectados a trav\'es de un camino del esqueleto.\\

Basado en este razonamiento, se dise\~n\'o un algoritmo que detecta la cantidad de
puntos extremos que son conectados a trav\'es de caminos de un determinado esqueleto,
y determina el tipo de grupo de gusanos al que pertenece. Aquellos esqueletos donde
se conectan exactamente dos puntos extremos a trav\'es de uno y solo un camino, corresponde
a gusanos aislados. Mientras que los esqueletos en donde m\'as de dos puntos extremos son
conectados corresponden a agrupaciones de gusanos.
Este procedimiento es descrito en los Algoritmos \ref{groupsegment} y \ref{groupsegment2}.

\begin{algorithm}[h]                     
\caption{Segmentaci\'on en grupos de gusanos}         
\label{groupsegment}                    
\begin{algorithmic}                   

\STATE $listaPtsExt \leftarrow$ lista de puntos extremos
\STATE $indiceAgrupacion \leftarrow$ 0
\FOR{$ptExtremo$ in $listaPtsExt$}
\IF{$ptExtremo.visitado()$}
\STATE \COMMENT{saltar iteraci\'on}
\ELSE
\STATE $indiceAgrupacion +=1$
\STATE $segmentarPorCaminos(ptExtremo,indiceAgrupacion)$
\ENDIF
\ENDFOR
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[h]                     
\caption{Seguimiento de caminos para segmentaci\'on ($segmentarPorCaminos(ptActual,clusterCount)$ )}         
\label{groupsegment2}
\begin{algorithmic}                   

\REQUIRE $ptActual$
\REQUIRE $indiceAgrupacion$

\IF{not $ptActual.esPuntoEsqueleto()$}
\RETURN 
\ELSE
\STATE $agregar(ptExtremo,indiceAgrupacion)$
\ENDIF

\STATE \COMMENT{continuar siguimiento de camino}
\IF{$ptActual.esPtExtremo()$}
\STATE $marcarPtExtremoVisitado(ptActual)$
\ENDIF
\STATE $vecinos \leftarrow obtenerVecindad()$
\FOR{$v$ in $vecinos$}
\STATE $followPath(v,indiceAgrupacion)$
\ENDFOR

\end{algorithmic}
\end{algorithm}


\subsubsection*{Predicci\'on de Caminos}
\label{sec:pathguessing}

Una agrupaci\'on de gusano es definida por un esqueleto
que conectan puntos extremos a trav\'es de caminos. Sin embargo, hasta esta etapa,
se desconoce el par de puntos extremos que pertenecen a cada gusano en la imagen, y 
el mejor camino en el esqueleto
que conecte a cada par, y que mejor represente el eje central de cada gusano 
respectivo.\\

El algoritmo de optimizaci\'on, cubierto en la Sec. \ref{sec:metfit}, lleva a cabo un
proceso de manipulaci\'on de siluetas para ajustar formas de gusanos en la imagen, dados
dos puntos extremos y un camino que los conecte. Para calcular la forma de gusano m\'as probable
que parte de un punto extremo determinado, el algoritmo tendr\'ia que probar cada camino posible
que parte de dicho punto extremo y seleccionar el que mejor se ajuste, lo que tiende a traducirse  
en un alto costo en tiempo de ejecuci\'on.\\
Con el fin de reducir el tiempo de ejecuci\'on del algoritmo de ajuste de
formas, y as\'i mismo proveer un par\'ametro adicional para determinar la
factibilidad de los caminos analizados, se desarroll\'o un algoritmo de
predicci\'on de caminos. En s\'intesis, el algoritmo lleva a cabo una b\'usqueda
heur\'istica para determinar aquellos caminos que tienen mayor probabilidad
de representar a un gusano de la imagen.\\

El algoritmo de predicci\'on se basa en la idea de evitar caminos que
tienden a describir conformaciones no-naturales de gusanos. Para esto
es necesario identificar cambios abruptos en el camino y flexiones
poco comunes o imposibles en gusanos. La idea desarrollada para lograr
esto se centra en que cada paso siguiente que sea seleccionado, corresponda
a la direcci\'on m\'as coherente con respecto al camino que ha sido
trazado hasta ese momento. 
M\'as espec\'ificamente, se escoge el conjunto $S$ de los \'ultimos $N$ 
pasos trazados, y a partir de este, se calcula la direcci\'on m\'as com\'unmente
seguida en esa porci\'on del recorrido.\\

Una dificultad considerable que surge de este
enfoque, es que el seguimiento del camino tiende a evitar \emph{centros de bifurcaciones}.
Una bifurcaci\'on ocurre cuando m\'as de un camino diferente puede ser seguido a partir
de un punto determinado. Dado que estas bifurcaciones son originadas por solapamiento 
de gusanos, el \'area de la bifurcaci\'on suele ser grande, y por tanto hay mayor 
cantidad de p\'ixeles posibles a escoger como siguiente paso. Los \emph{centros de bifurcaciones}
son aquellos puntos que se ubican en la zona m\'as c\'entrica de estas \'areas, y por tanto
se encuentran a una distancia normalmente similar de todos los caminos que se bifurcan.
Para poder determinar con mayor precisi\'on el camino m\'as adecuado a seguir, el trazado del camino 
debe tender a los \emph{centros de bifurcaciones}. Sin embargo, siguiendo el enfoque presentado, estos
centros se tienden a bordear. Por esta raz\'on se desarroll\'o una heur\'istica, que permita
al recorrido tender hacia los \emph{centros de bifurcaciones} y llevar as\'i a una 
decisi\'on mejor informada.\\

La heur\'istica consiste b\'as\'icamente en considerar el valor en el mapa de distancias
del pixel elegible, multiplicado por un factor de equilibrio. De esta manera, la 
selecci\'on del pixel siguiente se basa en dos valores fundamentales: la cantidad
de veces que ha sido escogida la direcci\'on en la que se encuentra dicho pixel, 
en los \'ultimos $N$ pasos, y el valor de la heur\'istica para ese pixel. Esto
puede expresarse de la siguiente forma:

$$Siguiente(p) = \max_{s \in vecindad(p)} (valorDir(direccion(p,s),N) + td(n)*factorH)$$

donde $p$ es el \'ultimo pixel marcado, $valorDir$ es una funci\'on que calcula
la cantidad de veces que la direcci\'on del pixel vecino $s$ ha sido escogida, $td$ es el 
mapa de distancia y $factorH$ es el factor heur\'istico que controla la influencia 
del mapa de distancia.\\


El Algoritmo \ref{guess} presenta un pseudo-c\'odigo para este enfoque de predicci\'on
de caminos de gusanos.

\begin{algorithm}[h]                    
\caption{Pseudo c\'odigo: Algoritmo de predicci\'on de caminos}
\label{guess}                    
\begin{algorithmic}                   

\STATE $listaPtsExtremos \leftarrow$ lista de puntos extremos
\STATE $longitud \leftarrow$ longitud estimada de gusanos multiplicada por un factor escalar
\FOR{$puntoExtremo$ in $listaPtsExtremos$}
\IF{$alcanzado(puntoExtremo)$}
\STATE \COMMENT{saltar iteracion}
\ENDIF
\STATE{$marcarComoAlcanzado(puntoExtremo)$}

\STATE $camino \leftarrow$ lista vacia

\STATE $extremoAlcanzado \leftarrow False$
\STATE $pixelActual \leftarrow puntoExtremo$
\WHILE{$not(extremoAlcanzado)$ and $size(path)<longitud$}
\STATE $pixelActual \leftarrow obtenerMejorVecino(pixelActual)$
\STATE $actualizarArregloDirecciones(direccion(pixelActual))$
\STATE $camino.agregar(pixelActual)$
\IF{$esPuntoExtremo(pixelActual)$}
\STATE $extremoAlcanzado \leftarrow True$
\ENDIF
\ENDWHILE 

\ENDFOR

\end{algorithmic}
\end{algorithm}

\subsection{Descriptor de Forma}
\label{sec:metshapedescriptor}

Como se mencion\'o inicialmente en la Sec. \ref{met:description}, 
el enfoque metodol\'ogico dise\~nado se basa en la manipulaci\'on de 
siluetas de gusanos que se generan a partir de un descriptor de forma.
La forma de un gusano puede ser descrita en t\'erminos geom\'etricos
como objetos alargados, delgados y cil\'indricos. Dado que el proceso
de \emph{skeletonization} y la posterior segmentaci\'on de la imagen, hacen
posible obtener caminos entre pares de extremos de gusanos, un descriptor
de forma permitir\'ia construir siluetas de gusanos a lo largo del
eje central definido por el camino, lo que servir\'ia como par\'ametro
de entrada para el algoritmo de ajuste de formas.\\


El descriptor fue dise\~nado bas\'andose en la idea de generar una silueta
de gusano representativa alrededor del eje central. El descriptor consiste en
dos elementos principales: un conjunto de puntos control y un perfil de gusano.
El conjunto de puntos control est\'a conformado por $N$ puntos equidistantes a lo
largo del eje central del gusano definido por el esqueleto, incluyendo los
dos puntos extremos. Por su parte, el perfil de gusano define $N$ valores de 
grosor que son asociados a cada punto control, respectivamente. El grosor de
un punto control determinado representa el radio de la circunferencia que tiene
como centro a dicho punto. De esta manera, seleccionando dos puntos en posiciones
opuestas de la circunferencia de grosor de capa punto control, y uniendo luego estos
puntos a trav\'es de una curva suave, se obtiene una contorno
que modela la silueta del gusano, como se muestra en la Figura 
\ref{fig:descriptor}. 

\begin{figure}[h]
 \centering
   \includegraphics[scale=1]{descriptor/descriptor-vector.pdf}
 \caption{Construcci\'on de una forma de gusano basada en un descriptor de forma}
 \label{fig:descriptor}
\end{figure}

Para obtener un contorno que represente una forma de gusano de manera precisa,
la escogencia de los puntos opuestos en las circunferencias de grosor
debe tomar en cuenta las flexiones del esqueleto. Dado que el contorno se
construye de acuerdo al grosor de los puntos control, las flexiones del gusano
a representar ocurren en cada uno de los puntos control. El grado de flexi\'on
de cada punto control se calcula como el \'angulo que existe entre las rectas
que conectan dicho punto con el punto anterior y posterior, respectivamente.\\

Por cada punto control, se calcula la bisectriz del \'angulo de flexi\'on y luego
se marcan los dos puntos opuestos donde se intersecan la bisectriz y la circunferencia
de grosor. Al calcular una curva que pasa por todos estos puntos, se obtiene un
contorno suave que modela una forma de gusano.\\

Generar una curva suave alrededor de los puntos control mejora la precisi\'on
de la forma descrita, en comparaci\'on con trazar l\'ineas rectas que
conecten los puntos de contorno. Esta representaci\'on permite modelar el 
contorno con m\'as detalle, utilizando un cantidad considerablemente menor
de puntos. La curva suave es obtenida calculando un \emph{spline} cardinal
(ver Sec. \ref{sec:splines}) dados los puntos contorno.\\

El perfil de gusanos para un conjunto de puntos control de tama\~no determinado 
puede ser, tanto definido manualmente, como calculado autom\'aticamente a partir
de los gusanos aislados, como se explica en el siguiente punto.


\subsubsection*{Generaci\'on Autom\'atica de Perfiles}
\label{sec:metwormprof}

La forma de los gusanos aislados puede ser ajustada con precisi\'on, siguiendo
los puntos de contorno en el mapa de distancia, como se explica en la Sec. \ref{sec:metiso}.
Dado un conjunto de formas ajustadas de gusanos aislados y sus esqueletos respectivos, se 
puede generar un perfil de gusanos, midiendo el grosor de los puntos control y calculando
la media aritm\'etica de cada uno.\\

Para medir el grosor de cada punto control, se selecciona inicialmente un conjunto
de $N$ puntos equidistantes que cubren el esqueleto de un gusano aislado determinado.
Seguidamente, como se describe en la secci\'on previa, se calculan las bisectrices de los \'angulos
que existen entre las rectas que conectan los puntos control. A partir de cada punto control, 
se recorren los p\'ixeles de la bisectriz hasta que un punto de contorno es encontrado. Este
recorrido se hace en los dos sentidos, por lo que el proceso devuelve dos puntos de contorno.
A continuaci\'on, se calcula la distancia Euclidiana que existe desde cada punto control hasta
sus dos puntos opuestos respectivos, y se almacena el promedio de distancia.\\

Al repetir este proceso para cada gusano aislado se generan un conjunto de perfiles de gusanos
aislados, uno por cada gusano. A partir de este conjunto de perfiles, se calcula un perfil
general encontrando la media aritm\'etica de los valores de grosor por cada punto control.\\
Para que el perfil sea lo m\'as representativo posible, se descartan el $20\%$ de los gusanos
m\'as grandes y m\'as peque\~nos. El valor de grosor para los puntos extremos, \emph{i.e.} el
primer y \'ultimo punto en el conjunto de tama\~no $N$, es cero, por lo que en los extremos
solo se genera un punto de contorno, en vez de dos como en el resto de los puntos control.\\

Este proceso permite calcular entonces un perfil de grosor que define la distancia 
promedio de cada punto control a su punto de contorno m\'as cercano, haciendo posible
la generaci\'on de siluetas gen\'ericas de gusano alrededor de cualquier esqueleto.

\subsection{Rasterizaci\'on de Siluetas}
\label{sec:metrast}

El enfoque de ajuste de formas se centra en minimizar la distancia entre siluetas
generadas y las formas de gusanos en la imagen. Para medir esta distancia se debe 
conocer el \'area de la silueta que es deformada.\\
El \'area de la silueta puede ser calculada a partir de su contorno. En t\'erminos
del tipo de datos que aqu\'i se manejan, el \'area consiste en el conjunto de p\'ixeles
que son cubiertos por la silueta, incluyendo los p\'ixeles de contorno.\\

El enfoque seguido para calcular el \'area consiste en dividir
en tri\'angulos el espacio definido por el contorno cerrado de la silueta y luego
rasterizar cada tri\'angulo por separado. El t\'ermino rasterizar se
refiere al proceso de transformar una imagen descrita en t\'erminos vectoriales
en un conjunto de p\'ixeles, de manera que pueda ser visualizada.\\

La descomposici\'on de un pol\'igono en tri\'angulos simples, es un problema
cl\'as\'ico de computaci\'on gr\'afica. Diversas soluciones se han propuesto
como lo son: triangulaci\'on de Delaunay, triangulaci\'on de costo m\'inimo y
m\'etodo de \emph{ear clipping}, entre otros.
 
\subsubsection*{Implementaci\'on}

El m\'etodo de \emph{ear clipping} fue escogido por su capacidad para triangular pol\'igonos
c\'oncavos y su sencillez de implementaci\'on. Para convertir el contorno del gusano en un 
pol\'igono, se transforma el \emph{spline} que lo define en un conjunto discreto de puntos.
Cada punto sucesivo es conectado a trav\'es de rectas, definiendo un pol\'igono cerrado. 
Para que la representaci\'on poligonal no afecte la suavidad del contorno definido por el
\emph{spline}, se escogen los puntos discretos (p\'ixeles) lo m\'as cerca posible uno de otros.
Seguidamente el contorno poligonal es triangulado.\\

Cada tri\'angulo es \emph{rasterizado} siguiendo el algoritmo de rasterizaci\'on por barrido
explicado en \cite{scanconversion}. El algoritmo consiste en rasterizar 
l\'ineas horizontales entre los lados del triangulo hasta que el \'area es cubierta por completo.\\

Una vez \emph{rasterizados}, se pueden almacenar el \'area y el contorno de la silueta en
forma de datos manejables y visualizables. 

\subsection{Detecci\'on y Ajuste de Formas}
\label{sec:metfit}

Una vez que la imagen ha sido segmentada en diferentes grupos de gusanos; que se tiene
el esqueleto que representa el eje central de dichos grupos; y que se ha calculado un
perfil general de los gusanos en la imagen, se puede llevar a cabo el proceso de ajuste
de formas. Este proceso permite detectar los gusanos individuales que componen los 
diferentes grupos y almacenar sus formas respectivas en forma datos manejables y visualizables.\\

El proceso de detecci\'on y ajuste es diferente para cada tipo de grupos de gusanos: 
gusanos aislados y agrupaciones de gusanos. En esta secci\'on se explican las 
caracter\'isticas de este proceso en cada caso.

\subsubsection*{Ajuste de Formas en Gusanos Aislados}
\label{sec:metiso}

En esta etapa de la metodolog\'ia, se conocen los diferentes gusanos aislados
y se tiene, por cada uno, un esqueleto delgado que conecta dos puntos
extremos de gusano a trav\'es de un camino.
Dado que este proceso es llevado a cabo despu\'es de que cada punto extremo
ha sido identificado correctamente y se conoce que el esqueleto no tiene
bifurcaciones, el \'area conformada por los p\'ixeles objeto del grupo
segmentado corresponder\'an a la forma exacta del gusano aislado en la
imagen.\\

Con el prop\'osito de tener una informaci\'on m\'as amplia acerca de los gusanos
detectados, se calcula tambi\'en el contorno a partir del \'area previamente identificada.
El contorno es trazado encontrando el pixel de borde m\'as cercano a alg\'un punto extremo
del gusano y recorriendo cada pixel de contorno vecino hasta cerrar el camino. 
Un pixel de contorno es aquel que tiene el valor de uno (1) en el mapa de distancias.\\

Este proceso permite, entonces, obtener el contorno y el \'area de cada
gusano aislado en la imagen, de manera precisa.

\subsubsection*{Ajuste de formas en Agrupaciones de Gusanos}
\label{sec:clusterfit}

Las agrupaciones de gusanos representan un escenario de detecci\'on m\'as complicado, 
debido a la cantidad variable de gusanos que los conforman y el solapamiento entre estos.
El solapamiento entre gusanos hace dif\'icil diferenciar el conjunto de p\'ixeles que pertenecen
al \'area de un gusano u otro. Por esta raz\'on, se dise\~n\'o un proceso de ajuste de formas
que se encarga de calcular las conformaciones o formas de gusanos factibles que parten
de cada punto extremo, para luego determinar el conjunto de conformaciones que mejor
ajustan la agrupaci\'on de gusanos como un todo.\\

El ajuste de formas sigue un enfoque de optimizaci\'on basado en la minimizaci\'on
de distancias entre gusanos de la agrupaci\'on y siluetas gen\'ericas, que son deformadas
para ajustarse a ella. Por lo tanto, una conformaci\'on de gusano es obtenida cuando
la disimilitud entre una silueta deformada y un \'area determinada de la agrupaci\'on, 
es la m\'inima posible.\\

A continuaci\'on, se describen los pasos y caracter\'isticas principales de este proceso:


\begin{itemize}
\item Por cada punto extremo se calcula el conjunto de caminos del esqueleto factibles
que comienzan en ese extremo.
\item Dado un camino del esqueleto, se construye una silueta gen\'erica a trav\'es
del descriptor de forma y el perfil de gusanos en la imagen. La silueta es dispuesta
a lo largo del camino.
\item Un proceso de optimizaci\'on se encarga de deformar la silueta hasta que la
disimilitud (distancia) entre dicha silueta y la imagen binaria es minimizada. Una
vez optimizada, la silueta corresponder\'a a una conformaci\'on de gusano factible.
\item Una vez que se han calculado todas las posibles conformaciones que parten 
de cada punto extremo, se selecciona el conjunto de conformaciones que maximiza
el n\'umero de puntos extremos cubiertos y minimiza el valor de distancia acumulado.
Las conformaciones seleccionadas corresponden a los mejores ajustes que se pueden
obtener de forma autom\'atica.
\item Las conformaciones escogidas que no representan a un gusano real en la imagen
(conformaciones incorrectas) pueden ser corregidas a trav\'es de un sencillo proceso
manual.
\end{itemize}

\subsubsection*{Deformaci\'on de Siluetas}
\label{sec:defsil}

Los caminos del esqueleto que son calculados (que van de un punto extremo a otro), 
corresponden a aproximaciones de posibles esqueletos de gusanos en la imagen. 
Dado que el modelo a deformar se construye sobre un camino del esqueleto
(que tiende al eje medio de un \'area de la agrupaci\'on de gusanos), la 
silueta generada inicialmente se encontrar\'a siempre cerca de una forma
de gusano real. Dado esto, a trav\'es de perturbaciones simples y ligeras de la silueta generada, 
se podr\'a deformar el modelo lo suficiente como para corregir la desviaci\'on del
esqueleto con respecto al eje central real del gusano a ajustar. De esta manera, se permite obtener  
la forma de gusano mejor aproximada que se puede calcular a partir del camino dado.\\

La deformaci\'on de la silueta se hace a trav\'es del descriptor de forma, que se 
encuentra definido por un conjunto de puntos control. Con el objetivo de proveer
formas de gusano factibles y para limitar la cantidad de deformaciones posibles,
una deformaci\'on consistir\'a en el reposicionamiento de un punto control.
La cantidad de posiciones diferentes que un punto control puede tomar es fija,
y son dispuestas a lo largo de la bisectriz del \'angulo del punto control. 
Este \'angulo depende, a su vez, de la posici\'on de los otros puntos control.\\
Siguiendo esto, se puede obtener un gran conjunto de deformaciones posibles
de forma r\'apida.

\subsubsection*{Funcional de Energ\'ia}
\label{sec:energyformulation} 

La funci\'on de distancia debe proveer una medida de que tan bien se aproxima la silueta que se
deforma a un gusano en la imagen, \emph{i.e.} que tan bien se ajusta la forma deformada.
Para esto se utiliz\'o el concepto de funcional de energ\'ia, tal como se define
en el modelo de contornos activos, \cite{snakes}.\\

El funcional de energ\'ia describe la distancia entre el modelo que se deforma 
y la imagen, y gu\'ia el proceso de ajuste de contornos. De esta manera, mientras menor
sea el valor devuelto por el funcional de energ\'ia, menor es la distancia y por tanto
mejor se ajusta el modelo. El funcional es formulado en base a dos 
conceptos: la energ\'ia externa y la energ\'ia interna. La suma de los valores
de la energ\'ia externa e interna relativas a un modelo, constituye el valor
de energ\'ia para ese modelo espec\'ifico.\\

La energ\'ia externa describe que tan bien se ajusta el modelo deformado a la 
imagen. Conociendo que, mientras mayor es la cantidad de p\'ixeles de fondo que son cubiertos 
por el modelo m\'as alejado se encuentra el modelo de un gusano en una agrupaci\'on, 
una medida apropiada para la energ\'ia interna ser\'ia 
la proporci\'on de p\'ixeles de fondo que son cubiertos por el modelo deformado.
De esta manera, mientras mayor es la cantidad de p\'ixeles de objeto 
que son cubiertos, menor es el valor de la energ\'ia externa.
Por lo tanto, dado un modelo $M$ y la funciones $bg$ y $fg$ que miden la cantidad
de p\'ixeles de fondo y de objeto que cubre el modelo, respectivamente, se puede
definir la energ\'ia externa para este problema de la siguiente forma:

$$E_{ext}(M) = \frac{bg(M)}{bg(M)+fg(M)}$$

Otra posibilidad consistir\'ia en tomar en cuenta, \'unicamente, la cantidad
de p\'ixeles de fondo. Sin embargo, dado la variabilidad de la cantidad de p\'ixeles
que puede cubrir una silueta de gusano, esta medida causar\'ia a la energ\'ia externa
ser muy variable de una silueta a otra.\\

La energ\'ia interna modela la resistencia de la silueta (modelo) a perder, a trav\'es
de la deformaci\'on, las caracter\'isticas que la hacen representar a la clase que
modela, \emph{e.g.} la clase de gusanos. Esto significa que, para el problema que aqu\'i
se aborda, la energ\'ia interna modelar\'ia la resistencia de la silueta de gusano
a ser deformada de manera tal que dejase de ser representativa de un gusano.
Como se explica en \cite{snakes}, la energ\'ia interna funciona como una restricci\'on de 
suavidad de los contornos del modelo y se formula de forma expl\'icita (normalmente en
t\'erminos diferenciales). Sin embargo, en el enfoque propuesto en este trabajo,
cada silueta a deformar se genera a partir de un perfil de gusano ajustado a un
descriptor de forma, por lo que cada silueta generada pertenece inequ\'ivocamente
a la clase de siluetas de gusano. Por esta raz\'on no es necesario incluir la
energ\'ia interna en el funcional de energ\'ia.

\subsubsection*{Optimizaci\'on}

A trav\'es del  proceso de optimizaci\'on se desea obtener las conformaciones de gusanos factibles
dentro de una agrupaci\'on de gusano. El enfoque general se basa en producir siluetas gen\'ericas
a partir de los caminos del esqueleto que conectan puntos extremos de gusanos, y deformarlas
levemente de manera que se ajusten a la imagen lo mejor posible. 
Una vez que se tiene un descriptor de formas basado en el esqueleto 
(Sec. \ref{sec:metshapedescriptor}), un m\'etodo de deformaci\'on de siluetas 
(Sec. \ref{sec:defsil}) y una funci\'on objetivo que modele la distancia
entre las siluetas y la agrupaci\'on a ajustar (Sec. \ref{sec:energyformulation}), 
s\'olo basta escoger un m\'etodo de optimizaci\'on.\\

De acuerdo al enfoque que aqu\'i se presenta, se puede utilizar cualquier m\'etodo de 
optimizaci\'on que permita minimizar la funci\'on objetivo que define la distancia entre 
formas de gusanos, a partir de una soluci\'on factible inicial, que, a su vez, permite 
generar otras soluciones factibles a trav\'es de un m\'etodo de deformaci\'on.\\

Dado lo r\'apido que pueden ser calculados grandes conjuntos de deformaciones,
de acuerdo al enfoque presentado en la Sec. \ref{sec:defsil}, se escogi\'o
una meta heur\'istica de b\'usqueda local como m\'etodo de optimizaci\'on.
El proceso en general consiste en obtener el mejor individuo de la vecindad
que mejore el valor del funcional de energ\'ia, hasta que la funci\'on sea
minimizada.\\
La vecindad es calculada de la siguiente manera:
Para una silueta determinada, se efect\'uan cuatro deformaciones diferentes por cada punto
control. Particularmente, dos en cada una de las dos direcciones opuesta de la bisectriz
del punto control. Existen entonces $(N-2)*4$  
deformaciones posibles (vecinos) por cada silueta \footnote{Los puntos control que corresponden 
a los extremos permanecen fijos. Por eso el n\'umero de puntos control tomados en cuenta es $N-2$}, 
donde $N$ es el n\'umero de puntos control. De esta manera, una vecindad consiste en deformaciones
leves y ligeramente m\'as fuertes de una silueta de gusano para cada punto control.\\ 
Los puntos control que corresponden a los extremos del esqueleto permanecen fijos.\\

Una vez que la mejor silueta es obtenida, se lleva a cabo un proceso de correcci\'on
de contornos. Este proceso consiste en la expansi\'on o contracci\'on de determinadas 
secciones del contorno de la silueta, para adaptarla al gusano real de la imagen.
Esto es requerido dado que la silueta optimizada es generada inicialmente siguiendo un 
perfil de gusano, el cual representa la forma de los gusanos de una manera gen\'erica, y
por tanto no describe las formas exactas de los gusanos en la imagen.\\
En este proceso, los puntos de contorno construidos a partir de los puntos control son
empujados hacia puntos de contorno de la imagen, de acuerdo al mapa de distancias, ya
sea expandi\'endolos o contray\'endolos. Cada posici\'on nueva considerable para el punto
contorno debe poseer un valor en el mapa de distancia similar o menor al que pose\'ia
originalmente.

\subsubsection*{Selecci\'on de Conformaciones}

Despu\'es que el proceso de optimizaci\'on es llevado a cabo, se debe seleccionar
un subconjunto de conformaciones por cada agrupaci\'on de gusano, que representar\'a
la as\'ignaci\'on final de conformaciones y por tanto la soluci\'on encontrada al final
del proceso. El subconjunto seleccionado debe maximizar la cantidad
de puntos extremos cubiertos y minimizar la suma de las energ\'ias finales de
cada conformaci\'on (valor minimizado de la funci\'on objetivo).\\

Cada punto extremo debe corresponder como m\'aximo a una conformaci\'on. De esta
manera, a cada punto extremo le corresponde uno y s\'olo uno de los otros puntos extremos.
Por consiguiente, el subconjunto \'optimo de conformaciones corresponder\'a a la
as\'ignaci\'on de costo m\'inimo (energ\'ia de cada conformaci\'on) entre el 
conjunto de puntos extremos, por cada agrupaci\'on de gusano.\\

Esta as\'ignaci\'on puede ser resuelta resolviendo el problema de as\'ignaci\'on de
costo m\'inimo de un grafo no-bipartito. Sin embargo, dado la complejidad de
su implementaci\'on (y posible sobrecarga en rendimiento) de este algoritmo,
se dise\~n\'o una soluci\'on diferente, consistiendo en un algoritmo \emph{greedy}
iterativo. El algoritmo es aplicado a subgrupos de agrupaciones de gusanos.
Estos sub grupos estas comprendidos, \'unicamente, por puntos extremos que estan
conectados por caminos factibles. Los puntos extremos que pertenecen a subgrupos
ser\'an llamados puntos conflictivos.\\

El algoritmo consiste en lo siguiente: Dado $N$ puntos extremos conflictivos, se
construye una tabla de $NxN$ indicando el costo de la mejor conformaci\'on que 
conecta cada punto extremo con otro. Luego, para una fila inicial de puntos,
se selecciona el m\'inimo valor y se realiza una as\'ignaci\'on entre el punto
de la fila y correspondiente punto de la columna (siempre puntos diferentes).
A partir de aqu\'i, se elimina el resto de las conformaciones asociadas
a estos puntos extremos. Seguidamente, se repite el proceso entre las filas
restantes hasta encontrar una soluci\'on. Esta soluci\'on es almacenada, 
se reconstruye la tabla previa, y se repite el proceso nuevamente a partir
de una fila diferente, hasta que todas las filas han sido tomadas como
filas iniciales. De todas las soluciones encontradas en cada iteraci\'on,
se escoge aquella que cubre el mayor n\'umero de puntos extremos y que
posee el menor valor acumulado de energ\'ia.

\subsection{Correcci\'on Manual}
\label{sec:manualproc}

Un proceso de correcci\'on manual puede ser llevado a cabo para mejorar la efectividad
de la detecci\'on y ajuste de formas, permitiendo tanto agregar puntos extremos 
no identificados como corregir conformaciones incorrectas.

\subsubsection*{Correcci\'on de Puntos Extremos}
\label{sec:endpointop}

Los puntos extremos de gusanos son detectados inicialmente a trav\'es de la
identificaci\'on de extremos del esqueleto de la imagen. Sin embargo, cuando
el extremo de un gusano determinado se superpone con otra forma de gusano, la
figura que describen se vuelve continua en la imagen binaria, por lo que ser\'a
descrito como un camino continuo en el esqueleto. De ser as\'i, el punto 
extremo no podr\'a ser detectado. Dado que el proceso de ajuste de formas est\'a 
fundamentado en los caminos encontrados entre puntos extremos de gusanos, el hecho de obviar
puntos extremos podr\'ia afectar la efectividad de detecci\'on.\\

Los puntos extremos de gusanos pueden ser detectados f\'acilmente por el ojo humano, 
especialmente teniendo el esqueleto del grupo de gusanos. Por esta raz\'on, los puntos
obviados pueden ser agregados r\'apidamente, a trav\'es de un proceso manual. El proceso
consiste b\'asicamente en observar los puntos que han sido agregados, inferir los
puntos faltantes y agregarlos manualmente, \emph{e.g.} \emph{clickeando} el pixel
en \emph{Endrov}. Cuando un punto a\~nadido posee m\'as de un esqueleto vecino, el
usuario tendr\'a que remover el pixel adicional, para cumplir con la
definici\'on de punto extremo.\\

En resumen, el usuario puede agregar los puntos extremos faltantes, seleccionando
dicho pixel. En algunos casos, tendr\'a que seleccionar un pixel vecino para
desconectarlo de caminos incorrectos.

\subsubsection*{Correcci\'on de Conformaciones}
\label{sec:matchfix}

En caso de que algunas de las conformaciones as\'ignadas no sean correctas,
la soluci\'on puede corregirse de manera manual. Dado que en el proceso de
optimizaci\'on son calculadas todas las posibles conformaciones entre
pares de puntos extremos, la correcci\'on de as\'ignaciones incorrectas
se reduce a seleccionar el par de puntos extremos correctos. 
Un usuario no experimentado es capaz de reconocer las as\'ignaciones incorrectas
con facilidad, as\'i como los puntos extremos que estas conectan, por lo que
el proceso tender\'a a ser r\'apido.
